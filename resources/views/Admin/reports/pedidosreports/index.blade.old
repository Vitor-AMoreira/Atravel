@extends('Admin.layouts.app')
@section('content')

@php
    $users_array = ['sales@atravel.pt', 'incoming@atravel.pt', 'transfers@atravel.pt', 'bookings@atravel.pt', 'accounts@atravel.pt'];
@endphp

<script type="text/javascript" src="{{ URL::asset('js/relatorio.js') }}"></script>

<div class="w3-container">

<script>
    var assetBaseUrl = "{{ asset('') }}";
</script>

<span class="w3-center"><h1>Payments Controll
    @if(in_array(Auth::user()->email, $users_array))
        @if(Request::segment(2) != "ats")
            <a style="font-size:16px;" href="{{url('/pedidosreports/ats')}}">with ATS</a>
        @else
            <a style="font-size:16px;" href="{{url('/pedidosreports')}}">without ATS</a>
        @endif
    @endif
</h1></span>
<div class="container-fluid">
    <div class="row" style="padding:30px 0;">
        @if(Request::segment(2) != "ats")
            {{ Form::open(array('url' => '/pedidosreports.search', 'method' => 'post', 'id' => 'search')) }}
        @else
            {{ Form::open(array('url' => '/pedidosreports.search/ats', 'method' => 'post', 'id' => 'search')) }}
        @endif
        <div class="col-lg-2 col-sm-6 col-md-2">
            <label class="ats-label">Operator</label>
            <!--<input value="{{session('operator')}}" type="text" class="form-control ats-border-color" id="operator" name="operator">-->
            <select width="100%"  id="operator" name="operator" class="form-control ats-border-color select-simple">
                <option value="0">Select</option>
                @foreach($utilizadores as $operadores)
                    @if(session('operator') == $operadores->id)
                        <option selected value="{{$operadores->id}}">{{$operadores->name}}</option>
                    @else
                        <option value="{{$operadores->id}}">{{$operadores->name}}</option>
                    @endif
                @endforeach
            </select>
        </div>

        <div class="col-lg-2 col-sm-6 col-md-2">
            <label class="ats-label">Supplier</label>
            <!--<input value="{{session('hotel')}}" type="text" class="form-control ats-border-color" id="hotel" name="hotel">-->
            <select width="100%" class="form-control ats-border-color select-simple" id="hotel" name="hotel">
                <option value="0">Select</option>
                @foreach($produtos as $produto)
                    @if(session('hotel') == $produto->id)
                        <option selected value="{{$produto->id}}">{{$produto->nome}}</option>
                    @else
                        <option value="{{$produto->id}}">{{$produto->nome}}</option>
                    @endif
                @endforeach
            </select>
        </div>
        <div class="col-lg-2 col-sm-6 col-md-2">
            <label class="ats-label">Client</label>
            <div class="form-group">
                <div class="input-group" style="position: relative;">
                    <input value="{{session('client')}}" type="text" class="form-control ats-border-color" id="client" name="client">
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-sm-6 col-md-2">
            <label class="ats-label">Start</label>
            <div class="form-group">
                <div class="input-group" style="position: relative;">
                <input autocomplete="off" value="{{Carbon\Carbon::parse(session('start'))->format('d-m-Y')}}" type="text" class="form-control ats-border-color datepicker" id="start" name="start" placeholder="Check-In">
                    <span class="input-group-addon ats-border-color">
                        <span class="w3-large ats-text-color fa fa-calendar"></span>
                    </span>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-sm-6 col-md-2">
            <label class="ats-label">End</label>
            <div class="form-group">
                <div class="input-group" style="position: relative;">
                    <input autocomplete="off" value="{{Carbon\Carbon::parse(session('end'))->format('d-m-Y')}}" type="text" class="form-control ats-border-color datepicker2" id="end" name="end" placeholder="Check-Out">
                    <span class="input-group-addon ats-border-color">
                        <span class="w3-large ats-text-color fa fa-calendar"></span>
                    </span>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-sm-6 col-md-2">
            <label class="ats-label"></label>
            <div class="form-group">
                <div class="input-group pull-right" style="position: relative; margin-top:4px;">
                    <button class="btn btn-primary"><i class="fa fa-search" aria-hidden="true"></i></button>
                    <div class="btn btn-primary" id="print-prof"><i class="fa fa-print" aria-hidden="true"></i></div>
                    <div class="btn btn-primary reset"><i class="fa fa-eraser" aria-hidden="true"></i></div>
                </div>
            </div>
        </div>
        {{ Form::close() }}
    </div>
</div>
<div class="w3-row-padding">
    <div class="container-fluid">
        <table class="table cell-border compact stripe" id="datatable-reports">
            <thead>
                <tr>
                    <th rowspan="2">Arr</th>
                    <th rowspan="2">Client</th>
                    <th rowspan="2">RNTS</th>
                    <th rowspan="2">Bed N.</th>
                    <th rowspan="2">ADR</th>
                    <th rowspan="2">Supplier</th>
                    <th rowspan="2">T.OPER</th>
                    <th style="background-color:yellow; text-align:center; border-left:1px solid #000;" colspan="9">Money Received</th>
                    @if(Request::segment(2) == "ats")
                        <th style="background-color:yellow; text-align:center; color:red;" colspan="7">Money Paid</th>
                    @endif
                </tr>
                <tr>
                    <th style="background-color:#0078ff;">ROOM</th>
                    <th style="background-color:#1dcb4a;">GOLF</th>
                    <th style="background-color:yellow;">TRA</th>
                    <th style="background-color:#ffdd97;">CAR</th>
                    <th style="background-color:#2ea7ff;">EXTRAS</th>
                    <th style="background-color:#1259b4;">K.BACK</th>
                    <th style="background-color:yellow;">TOTAL</th>
                    <th style="background-color:yellow;">V.PAID</th>
                    <th style="background-color:yellow;">UNPAID</th>
                    @if(Request::segment(2) == "ats")
                        <th style="background-color:#0078ff;">ROOM</th>
                        <th style="background-color:#1dcb4a;">GOLF</th>
                        <th style="background-color:yellow;">TRA</th>
                        <th style="background-color:#ffdd97;">CAR</th>
                        <th style="background-color:#2ea7ff;">EXTRAS</th>
                        <th style="background-color:yellow;">TOTAL</th>
                        <th style="background-color:#1dcb4a;">PROFIT</th>
                    @endif
                </tr>
            </thead>
            <tbody>
                @if($pedidos_reports)

                    @foreach($pedidos_reports as $pedido_report)

                    @php
                    if($produto_id){
                        $pedidos_produtos = App\PedidoProduto::where('pedido_geral_id', $pedido_report->pedido_geral_id)->get();
                    } else {
                        $pedidos_produtos = App\PedidoProduto::where('pedido_geral_id', $pedido_report->pedido_geral_id)->get();
                    }

                    @endphp

                    @if($pedidos_produtos->isEmpty() == false)
                        @php
                            $quarto_kick = 0;   $quarto_valor = 0;
                            $quarto_profit = 0; $quarto_markup = 0;
                            $quarto_extra = 0;  $num_nights = 0;
                            $num_rooms = 0;     $room_nights = 0;
                            $num_people = 0;    $bed_nights = 0;
                            $golf_kick = 0;     $golf_valor = 0;
                            $golf_profit = 0;   $golf_markup = 0;
                            $golf_extra = 0;    $transfer_kick = 0;
                            $transfer_valor =0; $transfer_profit = 0;
                            $transfer_markup=0; $transfer_extra = 0;
                            $car_kick = 0;      $car_valor = 0;
                            $car_profit = 0;    $car_markup = 0;
                            $car_extra = 0;     $ticket_kick = 0;
                            $ticket_valor = 0;  $ticket_profit = 0;
                            $ticket_markup = 0; $total_extras = 0;
                            $total_kickback = 0;$quarto_total = 0;
                            $golf_total = 0;    $transfer_total = 0;
                            $car_total = 0;     $ticket_total = 0;
                            $quarto_extra_profit = 0;   $golf_extra_profit = 0;
                            $transfer_extra_profit = 0; $car_extra_profit = 0;
                            $ticket_extra_profit = 0;   $total_extras_profit = 0;


                            foreach($pedidos_produtos as $pedido_produto){

                                $valores_quartos = App\ValorQuarto::where('pedido_produto_id', $pedido_produto->id)->get();
                                if($valores_quartos){
                                    $extra_quartos = 0;

                                    $pedidos_quartos = App\PedidoQuarto::where('pedido_produto_id', $pedido_produto->id)->get();
                                    foreach($pedidos_quartos as $pedido_quarto){
                                        $num_nights += $pedido_quarto->days;
                                        $num_rooms += $pedido_quarto->rooms;
                                        $num_people += $pedido_quarto->people;
                                        $bed_nights += $pedido_quarto->days * $pedido_quarto->people;
                                        $room_nights += $pedido_quarto->days * $pedido_quarto->rooms;
                                    }

                                    foreach($valores_quartos as $valor_quarto){
                                        $quarto_kick_liq = $valor_quarto->kick;
                                        $quarto_markup_liq = $valor_quarto->markup;

                                        $quarto_extra += $valor_quarto->valor_extra;
                                        $quarto_valor += $valor_quarto->valor_quarto;
                                        $quarto_profit += $valor_quarto->profit;

                                        $quarto_kick += (($quarto_kick_liq / 100) * $valor_quarto->valor_quarto);
                                        $quarto_markup += (($quarto_markup_liq / 100) * $valor_quarto->valor_quarto);

                                        $extra_quartos = App\PedidoProdutoExtra::where('pedido_produto_id', $pedido_produto->id)->get();
                                        if($extra_quartos){
                                            foreach($extra_quartos as $extra_quarto){
                                                $quarto_extra_profit += $extra_quarto->profit;
                                            }
                                        }
                                    }
                                }

                                $valores_golfes = App\ValorGolf::where('pedido_produto_id', $pedido_produto->id)->get();
                                if($valores_golfes){
                                    $extras_golfs = 0;
                                    foreach($valores_golfes as $valor_golf){
                                        $golf_kick_liq = $valor_golf->kick;
                                        $golf_markup_liq = $valor_golf->markup;

                                        $golf_extra += $valor_golf->valor_extra;
                                        $golf_valor += $valor_golf->valor_golf;
                                        $golf_profit += $valor_golf->profit;

                                        $golf_kick += (($golf_kick_liq / 100) * $valor_golf->valor_golf);
                                        $golf_markup += (($golf_markup_liq / 100) * $valor_golf->valor_golf);

                                        $extras_golfs = App\PedidoProdutoExtra::where('pedido_produto_id', $pedido_produto->id)->get();
                                        if($extras_golfs){
                                            foreach($extras_golfs as $extra_golf){
                                                $golf_extra_profit += $extra_golf->profit;
                                            }
                                        }
                                    }
                                }

                                $valor_transfer = App\ValorTransfer::where('pedido_produto_id', $pedido_produto->id)->get();
                                if($valor_transfer !== null){

                                        $extra_transfers = 0;
                                        foreach($valor_transfer as $valor){
                                            $transfer_kick_liq = $valor->kick;
                                            $transfer_markup_liq = $valor->markup;

                                            $transfer_extra += $valor->valor_extra;
                                            $transfer_valor += $valor->valor_transfer;
                                            $transfer_profit += $valor->profit;

                                            $transfer_kick += (($transfer_kick_liq / 100) * $valor->valor_transfer);
                                            $transfer_markup += (($transfer_markup_liq / 100) * $valor->valor_transfer);

                                            $extra_transfers = App\PedidoProdutoExtra::where('pedido_produto_id', $pedido_produto->id)->get();
                                            if($extra_transfers){
                                                foreach($extra_transfers as $extra){
                                                    $transfer_extra_profit += $extra->profit;
                                                }
                                            }
                                        }
                                }

                                $valores_cars = App\ValorCar::where('pedido_produto_id', $pedido_produto->id)->get();
                                if($valores_cars){
                                    $extras_cars = 0;
                                    foreach($valores_cars as $valor_car){
                                        $car_kick_liq = $valor_car->kick;
                                        $car_markup_liq = $valor_car->markup;

                                        $car_extra += $valor_car->valor_extra;
                                        $car_valor += $valor_car->valor_car;
                                        $car_profit += $valor_car->profit;

                                        $car_kick += (($car_kick_liq / 100) * $valor_car->valor_car);
                                        $car_markup += (($car_markup_liq / 100) * $valor_car->valor_car);

                                        $extras_cars = App\PedidoProdutoExtra::where('pedido_produto_id', $pedido_produto->id)->get();
                                        if($extras_cars){
                                            foreach($extras_cars as $extra_car){
                                                $car_extra_profit += $extra_car->profit;
                                            }
                                        }
                                    }
                                }

                                $valores_tickets = App\ValorTicket::where('pedido_produto_id', $pedido_produto->id)->get();
                                if($valores_tickets){
                                    $extra_tickets = 0;
                                    foreach($valores_tickets as $valor_ticket){
                                        $ticket_kick_liq = $valor_ticket->kick;
                                        $ticket_markup_liq = $valor_ticket->markup;

                                        $ticket_valor += $valor_ticket->valor_ticket;
                                        $ticket_profit += $valor_ticket->profit;

                                        $ticket_kick += (($ticket_kick_liq / 100) * $valor_ticket->valor_ticket);
                                        $ticket_markup += (($ticket_markup_liq / 100) * $valor_ticket->valor_ticket);

                                        $valores_tickets = App\PedidoProdutoExtra::where('pedido_produto_id', $pedido_produto->id)->get();
                                        if($extra_tickets){
                                            foreach($valores_tickets as $extra_ticket){
                                                $ticket_extra_profit += $extra_ticket->profit;
                                            }
                                        }
                                    }
                                }

                                $total_kickback = $golf_kick + $quarto_kick + $transfer_kick + $car_kick + $ticket_kick;
                                $total_markup = $golf_markup + $quarto_markup + $transfer_markup + $car_markup + $ticket_markup;

                                $quarto_total = $quarto_valor;
                                $golf_total = $golf_valor;
                                $transfer_total = $transfer_valor;
                                $car_total = $car_valor;
                                $ticket_total = $ticket_valor;
                                $total_extras = $quarto_extra + $golf_extra + $transfer_extra + $car_extra;

                                $total_pedido_value = $quarto_total + $golf_total + $transfer_total + $car_total + $ticket_total + $total_extras - $total_kickback + $total_markup;
                                $total_pedido_profit = $quarto_profit + $golf_profit + $transfer_profit + $car_profit;
                                $total_extras_profit = $quarto_extra_profit + $golf_extra_profit + $transfer_extra_profit + $car_extra_profit + $ticket_extra_profit;

                                $pedidos_payments = App\PedidoPayments::where('pedido_geral_id', $pedido_report->pedido_geral_id)->get();
                                $valor_pago = 0;
                                if($pedidos_payments){
                                    foreach($pedidos_payments as $payments){
                                        $valor_pago += $payments->payment;
                                    }
                                }
                            }
                        @endphp
                        <tr>
                            <td>
                                @if($pedido_report->checkin)
                                    <a class="hidden">{{ $pedido_report->checkin }}</a>
                                    {{ Carbon\Carbon::parse( $pedido_report->checkin )->format('d/m/y') }}
                                    {{-- Carbon\Carbon::parse( $pedido_report->checkin )->format('y/m/d') --}}
                                @endif
                            </td>
                            <td>{{$pedido_report->client}}</td>
                            <td style="text-align:center;">
                                @if($pedido_report->room_nights)
                                    {{-- {{$pedido_report->room_nights}} --}}
                                    {{$room_nights}}
                                @else
                                    0
                                @endif
                            </td>
                            <td>
                                @if($pedido_report->room_nights)
                                    {{number_format((float)$bed_nights, 2, '.', ' ')}}
                                @else
                                    0
                                @endif
                            </td>
                            <td>
                                @if($pedido_report->room_nights and $quarto_valor)
                                    {{number_format((float)$quarto_valor / (float)$room_nights, 2, '.', ' ')}}
                                @else
                                    0
                                @endif
                            </td>
                            <td>{{$pedido_report->produto}}</td>
                            <td>{{$pedido_report->operador}}</td>
                            <td style="text-align:right;">
                                @if($tipo == 'alojamento' || $tipo == null)
                                    {{number_format((float)$quarto_valor, 2, '.', '')}}
                                @else
                                    0.00
                                @endif
                            </td>
                            <td style="text-align:right;">
                                @if($tipo == 'golf' || $tipo == null)
                                    {{number_format((float)$golf_valor, 2, '.', '')}}
                                @else
                                    0.00
                                @endif
                            </td>
                            <td style="text-align:right;">
                                @if($tipo == 'transfer' || $tipo == null)
                                    {{number_format((float)$transfer_valor, 2, '.', '')}}
                                @else
                                    0.00
                                @endif
                            </td>
                            <td style="text-align:right;">
                                @if($tipo == 'car' || $tipo == null)
                                    {{number_format((float)$car_valor, 2, '.', '')}}
                                @else
                                    0.00
                                @endif
                            </td>
                            <td style="text-align:right;">
                                {{number_format((float)$total_extras, 2, '.', '')}}
                            </td>
                            <td style="text-align:right;">{{number_format((float)$total_kickback, 2, '.', '')}}</td>

                            <td style="background-color:yellow;text-align:right;" data-comentario="coluna TOTAL">
                                @php $valorCobrado = (float)$quarto_total + (float)$golf_total + (float)$transfer_total + (float)$car_total + (float)$ticket_total + (float)$total_extras - (float)$total_kickback + (float)$total_markup;
                                    $valorCobrado =  floor($valorCobrado*100)/100;
                                    echo $valorCobrado;
                                @endphp
                            </td>
                            <td style="background-color:yellow;text-align:right;" data-comentario="coluna vPaid">
                                 {{-- {{number_format( (float)$valor_pago, 2, '.', '')}} --}}
                                @php
                                    $valor_pago =  floor($valor_pago*100)/100;
                                    echo $valor_pago;
                                @endphp
                            </td>

                            <td style="background-color:yellow;text-align:right;" data-comentario="coluna unpaid">
                                @php
                                    //$temp = (float)$valor_pago -  (  (float)$quarto_total + (float)$golf_total + (float)$transfer_total + (float)$car_total + (float)$ticket_total + (float)$total_extras - (float)$total_kickback + (float)$total_markup );
                                    $temp = $valor_pago - $valorCobrado;
                                    /* {{  number_format( $valorTotalPago , 2, '.', '')  }} */
                                    $temp =  floor($temp * 100)/100;


                                    if($temp > 0){
                                        echo "<text style='color:green !important; font-weight: 600 '> + ".$temp."</text>";
                                    }else if($temp < 0){
                                        echo "<text style='color:red !important; font-weight: 600 '> - ".$temp."</text>";
                                    }else{
                                        echo $temp;
                                    }
                                @endphp
                            </td>
                            @if(Request::segment(2) == "ats")
                                <td style="text-align:right;">{{number_format( (float)$quarto_valor - (float)$quarto_profit, 2, '.', '')}}</td>
                                <td style="text-align:right;">{{number_format( (float)$golf_valor - (float)$golf_profit, 2, '.', '')}}</td>
                                <td style="text-align:right;">{{number_format( (float)$transfer_valor - (float)$transfer_profit, 2, '.', '')}}</td>
                                <td style="text-align:right;">{{number_format( (float)$car_valor - (float)$car_profit, 2, '.', '')}}</td>
                                <td style="text-align:right;" data-comentario="total_extra_ats">{{number_format( (float)$total_extras - (float)$total_extras_profit, 2, '.', '')}}</td>
                                <td style="background-color:yellow;text-align:right;">{{number_format( (float)$quarto_total + (float)$golf_total + (float)$transfer_total + (float)$car_total + (float)$ticket_total + (float)$total_extras - (float)$total_pedido_profit, 2, '.', '')}}</td>
                                <td style="background-color:#1dcb4a;text-align:right;">{{number_format( ((float)$quarto_total + (float)$golf_total + (float)$transfer_total + (float)$car_total + (float)$ticket_total + (float)$total_extras - (float)$total_kickback + (float)$total_markup) - ((float)$total_pedido_value - (float)$total_pedido_profit), 2, '.', '')}}</td>
                            @endif
                        </tr>
                        @endif
                    @endforeach
                @endif
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="2" style="text-align:right">Total:</th>
                    <th style="text-align:center;"></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th style="text-align:right;"></th>
                    <th style="text-align:right;"></th>
                    <th style="text-align:right;"></th>
                    <th style="text-align:right;"></th>
                    <th style="text-align:right;"></th>
                    <th style="text-align:right;"></th>
                    <th style="text-align:right;"></th>
                    <th style="text-align:right;"></th>
                    <th style="text-align:right;"></th>
                    @if(Request::segment(2) == "ats")
                        <th id="ats_profit" data-condition="true" style="text-align:right;"></th>
                        <th style="text-align:right;"></th>
                        <th style="text-align:right;"></th>
                        <th style="text-align:right;"></th>
                        <th style="text-align:right;"></th>
                        <th style="text-align:right;"></th>
                        <th style="text-align:right;"></th>
                    @endif
                </tr>
            </tfoot>
        </table>
    </div>

</div>

  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


@endsection

